# ğŸ—ï¸ Robust Bluetooth System - Architecture Overview

## ğŸ“ System Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         USER INTERFACE                          â”‚
â”‚                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚      printer_selection_screen.dart (UNCHANGED UI)        â”‚  â”‚
â”‚  â”‚  - Tab controller (WiFi, Bluetooth, USB)                 â”‚  â”‚
â”‚  â”‚  - Device list display                                   â”‚  â”‚
â”‚  â”‚  - Connection status                                     â”‚  â”‚
â”‚  â”‚  - Scan button â†’ Enhanced permission check              â”‚  â”‚
â”‚  â”‚  - Error listener â†’ Shows Arabic messages               â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                              â†•                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                               â†•
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      STATE MANAGEMENT                           â”‚
â”‚                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚               PrinterCubit (BLoC)                        â”‚  â”‚
â”‚  â”‚                                                          â”‚  â”‚
â”‚  â”‚  Methods:                                                â”‚  â”‚
â”‚  â”‚  â€¢ scanPrinters() â†’ Delegates to PrinterService         â”‚  â”‚
â”‚  â”‚  â€¢ connectToPrinter() â†’ Delegates to PrinterService     â”‚  â”‚
â”‚  â”‚  â€¢ requestBluetoothPermissions()                        â”‚  â”‚
â”‚  â”‚  â€¢ _getErrorMessage() â†’ Maps errors to Arabic           â”‚  â”‚
â”‚  â”‚                                                          â”‚  â”‚
â”‚  â”‚  States:                                                 â”‚  â”‚
â”‚  â”‚  â€¢ PrinterScanning                                       â”‚  â”‚
â”‚  â”‚  â€¢ PrintersFound                                         â”‚  â”‚
â”‚  â”‚  â€¢ PrinterConnecting                                     â”‚  â”‚
â”‚  â”‚  â€¢ PrinterConnected                                      â”‚  â”‚
â”‚  â”‚  â€¢ PrinterError (with Arabic message)                   â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                              â†•                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                               â†•
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      SERVICE LAYER                              â”‚
â”‚                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚              PrinterService (Core)                       â”‚  â”‚
â”‚  â”‚                                                          â”‚  â”‚
â”‚  â”‚  scanBluetoothPrinters():                               â”‚  â”‚
â”‚  â”‚    1. Pre-flight check â†’ BluetoothEnvironmentService   â”‚  â”‚
â”‚  â”‚    2. If ready â†’ Scan with timeout                     â”‚  â”‚
â”‚  â”‚    3. If not â†’ Throw specific error                    â”‚  â”‚
â”‚  â”‚    4. Log results                                       â”‚  â”‚
â”‚  â”‚    5. Return devices                                    â”‚  â”‚
â”‚  â”‚                                                          â”‚  â”‚
â”‚  â”‚  _connectToBluetoothPrinter():                          â”‚  â”‚
â”‚  â”‚    1. Pre-flight check                                  â”‚  â”‚
â”‚  â”‚    2. Safe disconnect previous                          â”‚  â”‚
â”‚  â”‚    3. Verify device paired                              â”‚  â”‚
â”‚  â”‚    4. Connect with timeout (15s)                        â”‚  â”‚
â”‚  â”‚    5. Retry once if fails (2s delay)                    â”‚  â”‚
â”‚  â”‚    6. Verify connection active                          â”‚  â”‚
â”‚  â”‚    7. Save connected printer                            â”‚  â”‚
â”‚  â”‚                                                          â”‚  â”‚
â”‚  â”‚  Dependencies:                                           â”‚  â”‚
â”‚  â”‚  â€¢ BluetoothEnvironmentService                          â”‚  â”‚
â”‚  â”‚  â€¢ PrinterErrorMapper                                   â”‚  â”‚
â”‚  â”‚  â€¢ Logger                                                â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                              â†•                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                               â†•
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    VALIDATION LAYER                             â”‚
â”‚                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚     BluetoothEnvironmentService (Pre-flight)            â”‚ â”‚
â”‚  â”‚                                                         â”‚ â”‚
â”‚  â”‚  performPreFlightCheck():                              â”‚ â”‚
â”‚  â”‚    1. Check Bluetooth available                        â”‚ â”‚
â”‚  â”‚    2. Check Bluetooth enabled                          â”‚ â”‚
â”‚  â”‚    3. Check Location enabled                           â”‚ â”‚
â”‚  â”‚    4. Check Permissions granted                        â”‚ â”‚
â”‚  â”‚    5. Return detailed results                          â”‚ â”‚
â”‚  â”‚                                                         â”‚ â”‚
â”‚  â”‚  Returns: BluetoothEnvironmentCheck {                  â”‚ â”‚
â”‚  â”‚    isReady: bool                                        â”‚ â”‚
â”‚  â”‚    missingRequirements: List<String>                   â”‚ â”‚
â”‚  â”‚    error: BluetoothEnvironmentError?                   â”‚ â”‚
â”‚  â”‚  }                                                      â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                              â†•                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚          PermissionService (Runtime)                    â”‚ â”‚
â”‚  â”‚                                                         â”‚ â”‚
â”‚  â”‚  requestBluetoothPermissions():                        â”‚ â”‚
â”‚  â”‚    â€¢ Request BLUETOOTH_SCAN                            â”‚ â”‚
â”‚  â”‚    â€¢ Request BLUETOOTH_CONNECT                         â”‚ â”‚
â”‚  â”‚    â€¢ Request LOCATION                                  â”‚ â”‚
â”‚  â”‚    â€¢ Log all states                                    â”‚ â”‚
â”‚  â”‚    â€¢ Return PermissionResult                           â”‚ â”‚
â”‚  â”‚                                                         â”‚ â”‚
â”‚  â”‚  checkBluetoothPermissions():                          â”‚ â”‚
â”‚  â”‚    â€¢ Check all 3 permissions                           â”‚ â”‚
â”‚  â”‚    â€¢ Return bool                                        â”‚ â”‚
â”‚  â”‚                                                         â”‚ â”‚
â”‚  â”‚  openSettings():                                        â”‚ â”‚
â”‚  â”‚    â€¢ Open app settings page                            â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                               â†•
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      ERROR HANDLING LAYER                       â”‚
â”‚                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚          PrinterErrorMapper (Centralized)               â”‚ â”‚
â”‚  â”‚                                                         â”‚ â”‚
â”‚  â”‚  mapError(dynamic error):                              â”‚ â”‚
â”‚  â”‚    â€¢ Analyze error string/type                         â”‚ â”‚
â”‚  â”‚    â€¢ Match to known error patterns                     â”‚ â”‚
â”‚  â”‚    â€¢ Return PrinterError with:                         â”‚ â”‚
â”‚  â”‚      - Unique code (E001-E999)                         â”‚ â”‚
â”‚  â”‚      - Technical message                               â”‚ â”‚
â”‚  â”‚      - User message (English)                          â”‚ â”‚
â”‚  â”‚      - Arabic title                                    â”‚ â”‚
â”‚  â”‚      - Arabic message                                  â”‚ â”‚
â”‚  â”‚      - Suggestions list                                â”‚ â”‚
â”‚  â”‚      - Recoverable flag                                â”‚ â”‚
â”‚  â”‚                                                         â”‚ â”‚
â”‚  â”‚  Error Categories:                                      â”‚ â”‚
â”‚  â”‚    E001-E004: Environment                              â”‚ â”‚
â”‚  â”‚    E101-E106: Connection                               â”‚ â”‚
â”‚  â”‚    E201:      Discovery                                â”‚ â”‚
â”‚  â”‚    E301:      Communication                            â”‚ â”‚
â”‚  â”‚    E401:      Network                                  â”‚ â”‚
â”‚  â”‚    E501:      Compatibility                            â”‚ â”‚
â”‚  â”‚    E999:      Unknown                                  â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                               â†•
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      PLATFORM LAYER                             â”‚
â”‚                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚              Android Permissions                        â”‚ â”‚
â”‚  â”‚                                                         â”‚ â”‚
â”‚  â”‚  AndroidManifest.xml:                                  â”‚ â”‚
â”‚  â”‚    â€¢ BLUETOOTH (â‰¤ API 30)                              â”‚ â”‚
â”‚  â”‚    â€¢ BLUETOOTH_ADMIN (â‰¤ API 30)                        â”‚ â”‚
â”‚  â”‚    â€¢ BLUETOOTH_SCAN (â‰¥ API 31)                         â”‚ â”‚
â”‚  â”‚    â€¢ BLUETOOTH_CONNECT (â‰¥ API 31)                      â”‚ â”‚
â”‚  â”‚    â€¢ ACCESS_FINE_LOCATION                              â”‚ â”‚
â”‚  â”‚    â€¢ ACCESS_COARSE_LOCATION                            â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                              â†•                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚         BlueThermalPrinter (Plugin)                     â”‚ â”‚
â”‚  â”‚                                                         â”‚ â”‚
â”‚  â”‚  â€¢ isAvailable                                          â”‚ â”‚
â”‚  â”‚  â€¢ isOn                                                 â”‚ â”‚
â”‚  â”‚  â€¢ getBondedDevices                                     â”‚ â”‚
â”‚  â”‚  â€¢ connect                                              â”‚ â”‚
â”‚  â”‚  â€¢ disconnect                                           â”‚ â”‚
â”‚  â”‚  â€¢ isConnected                                          â”‚ â”‚
â”‚  â”‚  â€¢ printBytes                                           â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”„ Data Flow - Scan Operation

```
User clicks "Scan" button
         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. PrinterSelectionScreen                     â”‚
â”‚    - If Bluetooth: Request permissions first  â”‚
â”‚    - If granted: Call cubit.scanPrinters()    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. PrinterCubit                                â”‚
â”‚    - Emit PrinterScanning state                â”‚
â”‚    - Call printerService.scanBluetoothPrinters()â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3. PrinterService                              â”‚
â”‚    - Call environmentService.performPreFlightCheck()â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 4. BluetoothEnvironmentService                 â”‚
â”‚    - Check Bluetooth available                 â”‚
â”‚    - Check Bluetooth enabled                   â”‚
â”‚    - Check Location enabled                    â”‚
â”‚    - Check Permissions granted                 â”‚
â”‚    - Return BluetoothEnvironmentCheck          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â†“
    â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”
    â”‚  Ready? â”‚
    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
         â”œâ”€â”€â”€ NO â”€â”€â†’ Throw specific error â†’ ErrorMapper â†’ PrinterError
         â”‚                                            â†“
         â”‚                                     PrinterCubit emits PrinterError
         â”‚                                            â†“
         â”‚                                     UI shows toast with Arabic message
         â”‚
         â””â”€â”€â”€ YES â”€â”€â†’ Continue scan
                            â†“
                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                â”‚ 5. PrinterService             â”‚
                â”‚    - Call bluetoothPrinter    â”‚
                â”‚      .getBondedDevices()      â”‚
                â”‚    - Timeout after 10 seconds â”‚
                â”‚    - Log device count         â”‚
                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚ Devices found? â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”œâ”€â”€â”€ NO â”€â”€â†’ Return empty list
                            â”‚                 â†“
                            â”‚          PrinterCubit emits PrintersFound([])
                            â”‚                 â†“
                            â”‚          UI shows "No devices" toast
                            â”‚
                            â””â”€â”€â”€ YES â”€â”€â†’ Return device list
                                             â†“
                                      PrinterCubit emits PrintersFound(devices)
                                             â†“
                                      UI displays devices in list
```

---

## ğŸ”„ Data Flow - Connect Operation

```
User selects printer from list
         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. PrinterSelectionScreen                     â”‚
â”‚    - Call cubit.connectToPrinter(device)       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. PrinterCubit                                â”‚
â”‚    - Emit PrinterConnecting state              â”‚
â”‚    - Call printerService.connectToPrinter()    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3. PrinterService                              â”‚
â”‚    - Call _connectToBluetoothPrinter()         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 4. Pre-flight Check                            â”‚
â”‚    - environmentService.performPreFlightCheck()â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â†“
    â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”
    â”‚  Ready? â”‚
    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
         â”œâ”€â”€â”€ NO â”€â”€â†’ Throw error
         â”‚
         â””â”€â”€â”€ YES â”€â”€â†’ Continue
                         â†“
                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                â”‚ 5. Safe Disconnect             â”‚
                â”‚    - _safeDisconnectBluetooth()â”‚
                â”‚    - Ignore disconnect errors  â”‚
                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â†“
                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                â”‚ 6. Verify Pairing              â”‚
                â”‚    - Get bonded devices        â”‚
                â”‚    - Find matching device      â”‚
                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â†“
                    â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”
                    â”‚  Paired? â”‚
                    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
                         â”œâ”€â”€â”€ NO â”€â”€â†’ Throw E104_PAIRING_REQUIRED
                         â”‚
                         â””â”€â”€â”€ YES â”€â”€â†’ Attempt connection
                                          â†“
                                 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                 â”‚ 7. Connection Attempt  â”‚
                                 â”‚    - Timeout: 15s      â”‚
                                 â”‚    - connect(device)   â”‚
                                 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                          â†“
                                     â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”
                                     â”‚ Success?  â”‚
                                     â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
                                          â”œâ”€â”€â”€ YES â”€â”€â†’ Save & emit success
                                          â”‚
                                          â””â”€â”€â”€ NO â”€â”€â†’ Retry?
                                                         â†“
                                                    â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”
                                                    â”‚ Attempt 1?â”‚
                                                    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
                                                         â”œâ”€â”€â”€ YES â”€â”€â†’ Wait 2s â†’ Retry
                                                         â”‚                 â†“
                                                         â”‚           Attempt 2
                                                         â”‚                 â†“
                                                         â”‚            Success/Fail
                                                         â”‚
                                                         â””â”€â”€â”€ NO (Attempt 2) â”€â”€â†’ Throw error
                                                                                      â†“
                                                                               ErrorMapper
                                                                                      â†“
                                                                               PrinterError
                                                                                      â†“
                                                                               Show message
```

---

## ğŸ§© Component Dependencies

```
PrinterSelectionScreen
    â”œâ”€ Depends on: PrinterCubit
    â”œâ”€ Depends on: PermissionService
    â””â”€ Displays: Toast notifications with errors

PrinterCubit
    â”œâ”€ Depends on: PrinterService
    â”œâ”€ Depends on: PermissionService
    â”œâ”€ Depends on: PrinterErrorMapper
    â””â”€ Emits: PrinterState (various states)

PrinterService
    â”œâ”€ Depends on: BluetoothEnvironmentService
    â”œâ”€ Depends on: PrinterErrorMapper
    â”œâ”€ Depends on: Logger
    â””â”€ Uses: BlueThermalPrinter plugin

BluetoothEnvironmentService
    â”œâ”€ Depends on: PermissionService
    â”œâ”€ Depends on: Logger
    â””â”€ Uses: BlueThermalPrinter plugin

PermissionService
    â”œâ”€ Depends on: Logger
    â””â”€ Uses: permission_handler package

PrinterErrorMapper
    â”œâ”€ Depends on: Logger
    â””â”€ Standalone (no dependencies)
```

---

## ğŸ“¦ File Organization

```
lib/
â”œâ”€â”€ cubits/
â”‚   â””â”€â”€ printer/
â”‚       â”œâ”€â”€ printer_cubit.dart        â† State management
â”‚       â””â”€â”€ printer_state.dart        â† State definitions
â”‚
â”œâ”€â”€ screens/
â”‚   â””â”€â”€ casher/
â”‚       â”œâ”€â”€ printer_selection_screen.dart  â† UI (minimal changes)
â”‚       â”œâ”€â”€ models/
â”‚       â”‚   â””â”€â”€ printer_device.dart        â† Data model
â”‚       â””â”€â”€ services/
â”‚           â””â”€â”€ printer_service.dart       â† Core business logic
â”‚
â”œâ”€â”€ services/
â”‚   â”œâ”€â”€ bluetooth_environment_service.dart  â† Pre-flight validation
â”‚   â”œâ”€â”€ permission_service.dart             â† Runtime permissions
â”‚   â””â”€â”€ printer_error_mapper.dart           â† Error handling
â”‚
â””â”€â”€ widgets/
    â””â”€â”€ printer_dialog_helper.dart          â† UI helpers (optional)

android/
â””â”€â”€ app/
    â””â”€â”€ src/
        â””â”€â”€ main/
            â””â”€â”€ AndroidManifest.xml         â† Platform permissions
```

---

## ğŸ¯ Key Design Principles

### **1. Separation of Concerns**
```
UI Layer         â†’ Displays data, handles user input
State Layer      â†’ Manages application state
Service Layer    â†’ Business logic, API calls
Validation Layer â†’ Pre-flight checks
Error Layer      â†’ Centralized error handling
Platform Layer   â†’ Native permissions, plugins
```

### **2. Fail-Fast Strategy**
```
Check environment â†’ Fail if not ready
    â†“ (Ready)
Perform operation â†’ Fail if error
    â†“ (Success)
Return result
```

### **3. Error Propagation**
```
Low-level error (Exception)
    â†“
PrinterErrorMapper
    â†“
PrinterError (structured)
    â†“
PrinterCubit (maps to Arabic)
    â†“
UI (shows toast/dialog)
```

### **4. Retry Strategy**
```
Attempt 1 â†’ Fail
    â†“
Wait 2 seconds
    â†“
Attempt 2 â†’ Fail/Success
    â†“
No more retries (fail fast)
```

---

## ğŸ“Š State Transition Diagram

```
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚ PrinterInitialâ”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â”‚ scanPrinters()
                            â†“
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚PrinterScanningâ”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                â”‚                       â”‚
                â†“ Success               â†“ Error
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚PrintersFound â”‚        â”‚ PrinterError â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚
                â”‚ connectToPrinter()
                â†“
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚PrinterConnecting â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                        â”‚
    â†“ Success                â†“ Error
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚PrinterConnectedâ”‚     â”‚ PrinterError â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚
        â”‚ disconnect()
        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚PrinterDisconnectedâ”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ” Permission Flow

```
App Startup
    â†“
User navigates to printer settings
    â†“
User clicks "Scan" (Bluetooth)
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Check permissions          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
    â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”
    â”‚ Granted? â”‚
    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
         â”œâ”€â”€â”€ YES â”€â”€â†’ Proceed with scan
         â”‚
         â””â”€â”€â”€ NO â”€â”€â†’ Request permissions
                         â†“
                    â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”
                    â”‚  Result?  â”‚
                    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
                         â”œâ”€â”€â”€ GRANTED â”€â”€â†’ Proceed with scan
                         â”‚
                         â”œâ”€â”€â”€ DENIED â”€â”€â†’ Show toast
                         â”‚
                         â””â”€â”€â”€ PERMANENTLY_DENIED â”€â”€â†’ Show dialog with "Open Settings"
```

---

## ğŸ“ Summary

**This architecture provides:**
- âœ… **Clean separation** of concerns
- âœ… **Fail-fast** validation
- âœ… **Centralized** error handling
- âœ… **User-friendly** error messages
- âœ… **Comprehensive** logging
- âœ… **Robust** retry logic
- âœ… **Platform-aware** permission handling

**Result:** A rock-solid, production-ready Bluetooth printing system that never fails silently and always guides users to resolution! ğŸš€
